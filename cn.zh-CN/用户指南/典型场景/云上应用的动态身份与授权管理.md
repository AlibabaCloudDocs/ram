# 云上应用的动态身份与授权管理 {#concept_xdg_1vc_mfb .concept}

本文介绍了当用户购买阿里云产品后，通过 RAM 进行动态身份与授权管理，允许应用程序通过获取角色身份的动态令牌来访问云服务 API，以解决保密性和运维问题。

## 背景信息 {#section_01 .section}

用户购买了 ECS 实例，并且打算在 ECS 中部署企业的应用程序。这些应用程序需要使用 Access Key 访问其它云服务 API。有两种做法：

-   将 Access Key 直接嵌入在代码里。
-   将 Access Key 保存在应用程序的配置文件中。

这样会带来两个问题：

-   保密性问题：如果 Access Key 以明文形式存在于 ECS 实例中，它都可能随着快照、镜像及镜像创建出来的实例被泄露。
-   难运维性问题：由于Access Key存在于实例中，如果要更换 Access Key（比如周期性轮转或切换用户身份），那么需要对每个实例和镜像进行更新并重新部署，这会增加对实例和镜像管理的复杂性。

## 动态身份与授权解决方案 {#section_02 .section}

ECS 服务结合 RAM 提供的访问控制能力，允许给每一个 ECS 实例（即用户应用程序的运行环境）配置一个拥有合适权限的 RAM 角色身份，应用程序通过获取该角色身份的动态令牌来访问云服务 API。

![工作原理](images/14409_zh-CN.png "工作原理")

## 给 ECS 实例配置 RAM 角色的操作步骤 {#section_03 .section}

1.  云账号在 RAM 中创建一个 ECS 实例型 RAM 角色，并对角色授予合适的权限策略。

    **说明：** ECS 实例型 RAM 角色：是 RAM 服务角色中的一种类型，表示该角色是由用户创建并授权给该用户的 ECS 实例所使用。

2.  启动 ECS 实例时，配置创建好的 RAM 角色。

    -   （i）ECS 服务根据所配置的 RAM 角色，调用 AssumeRole 去访问 STS 请求获取该角色的 STS token。
    -   （ii）STS 服务会验证 ECS 服务身份及该角色的授权类型，验证通过后颁发 STS token，否则拒绝请求。
    详情请参考：[通过控制台使用实例 RAM 角色](../../../../../intl.zh-CN/用户指南/实例/实例RAM角色/通过控制台使用实例 RAM 角色.md#) 或 [通过 API 使用实例 RAM 角色](../../../../../intl.zh-CN/用户指南/实例/实例RAM角色/通过 API 使用实例 RAM 角色.md#)。

3.  获取到 STS token 后，ECS 将通过 Metadata 服务将 STS token 提供给实例中的应用程序访问。

    例如： 在 Linux 中执行如下命令，即可获取 STS token 及过期时间等元数据信息。

    ```
    $ curl http://100.100.100.200/latest/meta-data/ram/security-credentials/<roleName>
    ```

    **说明：** 

    -   STS token 过期时间通常为 1 小时，STS token 在有效期内都能正常访问云服务 API，在过期之前 ECS 服务会自动刷新 STS token。
    -   如果 STS token 权限不足，那么需要找管理员给实例 RAM 角色添加足够的权限。
    -   实例 RAM 角色的权限更新后，STS token 权限立即生效，无需重新启动 ECS 实例。
4.  使用 STS token 调用云服务 API。

    **说明：** 如果你的应用程序使用了阿里云 SDK，那么阿里云 SDK 将会自动从 ECS Metadata 服务中获取实例 RAM 角色的 STS token，开发者无需在 SDK 中配置任何 AccessKey 相关的信息。

    详情请参考：[配置RamRole实现ECS实例的无AK访问](../../../../../intl.zh-CN/Java SDK/使用手册/配置RamRole实现ECS实例的无AK访问.md#)。


## 管理员与操作员职责分离的原理 {#section_04 .section}

对于很多企业用户，授权者和 ECS 实例操作者通常都是职责分离，是不同的 RAM 用户。针对管理员与操作员职责分离原理如下：

![管理员与操作员职责分离原理图](images/14410_zh-CN.png "管理员与操作员职责分离原理图")

## 管理员与操作员职责分离的操作步骤 {#section_hpx_wwg_qgb .section}

**注意：** 

-   如果 RAM 用户不拥有管理员权限，仅有 ECS 权限。在创建 ECS 实例并配置 RAM 角色时，ECS服务会强制检查当前用户是否拥有指定 RAM 角色的 `ram:PassRole`权限，否则无法成功创建 ECS 实例。
-   只有被授权用户才能为 ECS 实例配置 RAM 角色，避免 RAM 角色权限被滥用。

若想实现管理员与操作员职责分离，只需在[给 ECS 实例配置 RAM 角色的操作步骤](#)的基础上，根据 Step 1.5 使管理员给操作员增加一个 `PassRole` 权限即可。

管理员可以通过 RAM 按如下 Policy 示例创建一个自定义策略，然后将这个自定义策略授权给操作员。

**注意：** 替换 `rolename` 为自己的 RAM 角色名称。

```


{
   "Statement": [
    {
      "Effect": "Allow",
      "Action": "ram:PassRole",
      "Resource": "acs:ram:*:*:role/<rolename>"
    }
  ],
  "Version": "1"
}

```

## 更多信息 {#section_n3k_rgx_pgb .section}

除了 ECS 服务之外，阿里云其它计算类服务如函数计算、MaxCompute 也都提供了类似的 RAM 角色访问能力，以帮助用户解决云上身份密钥管理的问题。

