# 移动设备应用使用临时安全令牌访问阿里云 {#concept_tdn_n2k_xdb .concept}

本文介绍移动设备应用如何使用 RAM 角色的临时安全令牌（STS token）访问阿里云相关资源。

## 前提条件 {#section_2uh_2nc_p4v .section}

请确保您已经注册了阿里云账号。如还未注册，请先完成 [账号注册](https://account.alibabacloud.com/register/intl_register.htm)。

## 背景信息 {#section_01 .section}

企业 A 开发了一款移动应用（App），并购买了对象存储（OSS）服务。App 需要直连 OSS 上传或下载数据，但是 App 运行在用户自己的移动设备上，这些设备不受企业 A 的控制。

企业 A 有如下要求：

-   直传数据：企业 A 不希望所有 App 都通过企业的服务端应用服务器（Application Server）来进行数据中转，而希望能够直连 OSS 上传或下载数据。
-   安全管控：企业 A 不希望将访问密钥（AccessKey）保存到移动设备中，因为移动设备是归属于用户控制，属于不可信的运行环境。
-   风险控制：企业 A 希望将风险控制到最小，每个 App 直连 OSS 时都必须拥有最小的访问权限且访问时效需要很短。

## 解决方案 {#section_03 .section}

当移动应用（App）直连 OSS 上传或下载数据时，App 需要向应用服务器申请访问凭证。应用服务器以 RAM 用户身份扮演 RAM角色，调用 STS API AssumeRole 接口获取临时安全令牌，并将临时安全令牌传递给 App，App 使用临时安全令牌访问 OSS。

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/23775/156155837614407_zh-CN.png)

1.  App 向应用服务器申请访问凭证。
2.  云账号 A 创建一个 RAM 角色，并为 RAM 角色授予合适的权限。

    操作流程请参考：[创建 RAM 角色并授权](#section_04)。

3.  云账号 A 为应用服务器创建一个 RAM 用户，并允许应用服务器以 RAM 用户身份扮演该 RAM 角色。

    操作流程请参考：[创建 RAM 用户并允许扮演 RAM 角色](#section_xsw_quq_4p3)。

4.  应用服务器通过调用 STS API [AssumeRole](../../../../intl.zh-CN/API 参考（STS）/操作接口/AssumeRole.md#) 接口获取 RAM 角色的临时安全令牌。

    操作流程请参考：[应用服务器获取临时安全令牌](#section_552_rvk_wrb)。

5.  应用服务器可以进一步限制临时安全令牌的权限，以更精细地控制每个 App 的权限。

    操作流程请参考：[限制临时安全令牌的权限](#section_e6m_2ec_my4)。

6.  当 App 需要直连 OSS 上传或下载数据时，可以使用临时安全令牌访问 OSS 进行数据直传。

    操作流程请参考：[App 使用临时安全令牌并访问 OSS](#section_05)。


## 创建 RAM 角色并授权 {#section_04 .section}

假设云账号 A 的账号 ID 为：`123456789012****`。

1.  云账号 A 创建可信实体为**阿里云账号**的 RAM 角色： `oss-readonly`。

    **说明：** 创建 RAM 角色时选择**当前云账号**作为受信云账号，即只允许云账号 A 下的 RAM 用户来扮演该 RAM 角色。

    关于如何创建 RAM 角色，详情请参考：[创建可信实体为阿里云账号的 RAM 角色](../../../../intl.zh-CN/用户指南/角色/创建 RAM 角色/创建可信实体为阿里云账号的 RAM 角色.md#)。

    RAM 角色创建成功后，在角色基本信息页面可以查看到该 RAM 角色的 ARN 和信任策略。

    -   RAM 角色的 ARN 如下：

        ``` {#codeblock_usn_129_y3k}
        acs:ram::123456789012****:role/oss-readonly
        ```

    -   RAM 角色的信任策略如下：

        **说明：** 以下策略表示只允许云账号 A 下的 RAM 用户来扮演 RAM 角色。

        ``` {#codeblock_kim_bz4_ccl}
        {
        "Statement": [
        {
         "Action": "sts:AssumeRole",
         "Effect": "Allow",
         "Principal": {
           "RAM": [
             "acs:ram::123456789012****:root"
           ]
         }
        }
        ],
        "Version": "1"
        }
        ```

2.  为 RAM 角色授权，向 RAM 角色：`oss-readonly` 授予 OSS 的只读访问权限：`AliyunOSSReadOnlyAccess`。

    关于如何为 RAM 角色授权，详情请参考：[为 RAM 角色授权](../../../../intl.zh-CN/用户指南/角色/为 RAM 角色授权.md#)。


## 创建 RAM 用户并允许扮演 RAM 角色 {#section_xsw_quq_4p3 .section}

1.  云账号 A 为应用服务器创建 RAM 用户：`appserver`。

    关于如何创建 RAM 用户，详情请参考：[创建 RAM 用户](../../../../intl.zh-CN/用户指南/用户/创建 RAM 用户.md#)。

2.  为创建好的 RAM 用户授予 `AliyunSTSAssumeRoleAccess` 权限，即允许 RAM 用户扮演 RAM 角色。

    关于如何为 RAM 用户授权，详情请参考：[为 RAM 用户授权](../../../../intl.zh-CN/用户指南/用户/为 RAM 用户授权.md#)。


## 应用服务器获取临时安全令牌 {#section_552_rvk_wrb .section}

1.  应用服务器使用 RAM 用户的访问密钥调用 STS API AssumeRole 接口。

    **说明：** 必须配置应用服务器的访问密钥，而非云账号 A 的访问密钥。

    使用阿里云 CLI 调用 AssumeRole 的示例如下：

    ``` {#codeblock_aoi_get_t3m}
    $ aliyuncli sts AssumeRole --RoleArn acs:ram::123456789012****:role/oss-readonly --RoleSessionName client-001
     {
         "AssumedRoleUser": {
             "AssumedRoleId": "391578752573****:client-001", 
             "Arn": "acs:ram::123456789012****:role/oss-readonly/client-001"
         }, 
         "Credentials": {
             "AccessKeySecret": "93ci2umK1QKNEja6WGqi1Ba7Q2Fv9PwxZqtVF2Vy****", 
             "SecurityToken": "********", 
             "Expiration": "2016-01-13T15:02:37Z", 
             "AccessKeyId": "STS.F13GjskXTjk38dBY6YxJt****"
         }, 
         "RequestId": "E1779AAB-E7AF-47D6-A9A4-53128708B6CE"
     }
    ```

    **说明：** 若没有指定 `Policy` 参数，返回的临时安全令牌将拥有 RAM 角色：`oss-readonly` 的所有权限。

2.  STS 服务将临时安全令牌返回给应用服务器。返回的临时安全令牌中包含：`AccessKeyId`、`AccessKeySecret` 和 `SecurityToken`。

    **说明：** `SecurityToken` 过期时间较短。如果需要一个较长的过期时间，应用服务器需要重新颁发临时安全令牌，例如：每隔 1800 秒颁发一次。


## 限制临时安全令牌的权限 {#section_e6m_2ec_my4 .section}

如果需要进一步限制临时安全令牌的权限，可以通过配置 `Policy` 参数来实现。

以下示例表示：只允许访问 `sample-bucket/2015/01/01/*.jpg`。

``` {#codeblock_3wx_zt3_qn4}
$ aliyuncli sts AssumeRole --RoleArn acs:ram::123456789012****:role/oss-readonly --RoleSessionName client-002 --Policy "{\"Version\":\"1\", \"Statement\": [{\"Effect\":\"Allow\", \"Action\":\"oss:GetObject\", \"Resource\":\"acs:oss:*:*:sample-bucket/2015/01/01/*.jpg\"}]}"
{
   "AssumedRoleUser": {
       "AssumedRoleId": "391578752573****:client-002", 
       "Arn": "acs:ram::123456789012****:role/oss-readonly/client-002"
   }, 
   "Credentials": {
       "AccessKeySecret": "28Co5Vyx2XhtTqj3RJgdud4ntyzrSNdUvNygAj7x****", 
       "SecurityToken": "********", 
       "Expiration": "2016-01-13T15:03:39Z", 
       "AccessKeyId": "STS.FJ6EMcS1JLZgAcBJSTDG1****"
   }, 
   "RequestId": "98835D9B-86E5-4BB5-A6DF-9D3156ABA567"
}
```

**说明：** 临时安全令牌的默认过期时间为 3600 秒。通过 `DurationSeconds` 参数可以限制其过期时间，最长不超过 3600 秒。

## App 使用临时安全令牌并访问 OSS {#section_05 .section}

1.  应用服务器将临时安全令牌传递给 App。
2.  App 使用临时安全令牌访问 OSS。

    下面是阿里云 CLI 使用临时安全令牌访问 OSS 的示例：

    ``` {#codeblock_32r_o8v_guj}
    配置临时安全令牌语法：aliyuncli oss Config --host  --accessid  --accesskey  --sts_token 
    $ aliyuncli oss Config --host oss.aliyuncs.com --accessid STS.FJ6EMcS1JLZgAcBJSTDG1**** --accesskey 28Co5Vyx2XhtTqj3RJgdud4ntyzrSNdUvNygAj7x**** --sts_token CAESnQMIARKAASJgnzMzlXVyJn4KI+FsysaIpTGm8ns8Y74HVEj0pOevO8ZWXrnnkz4a4rBEPBAdFkh3197GUsprujsiU78FkszxhnQPKkQKcyvPihoXqKvuukrQ/Uoudk31KAJEz5o2EjlNUREcxWjRDRSISMzkxNTc4NzUyNTczOTcyODU0KgpjbGllbnQtMDAxMKmZxIHBKjoGUnNhTUQ1Qn8KATEaegoFQWxsb3cSJwoMQWN0aW9uRXF1YWxzEgZBY3Rpb24aDwoNb3NzOkdldE9iamVjdBJICg5SZXNvdXJjZUVxdWFscxIIUmVzb3VyY2UaLAoqYWNzOm9zczoqOio6c2FtcGxlLWJ1Y2tldC8yMDE1LzAxLzAxLyouanBnSgU0MzI3NFIFMjY4NDJaD0Fzc3VtZWRSb2xlVXNlcmAAahIzOTE1Nzg3NTI1NzM5NzI4NTRyCWVjcy1hZG1pbnjgxt7Cj/bo****
    访问 OSS
    $ aliyuncli oss Get oss://sample-bucket/2015/01/01/grass.jpg grass.jpg
    ```


## 更多参考 {#section_07 .section}

关于移动应用直传场景，请参考以下文档：

-    [快速搭建移动应用直传服务](../../../../intl.zh-CN/最佳实践/移动应用端直传实践/快速搭建移动应用直传服务.md) 
-    [权限控制](../../../../intl.zh-CN/最佳实践/移动应用端直传实践/权限控制.md) 
-    [快速搭建移动应用上传回调服务](../../../../intl.zh-CN/最佳实践/移动应用端直传实践/快速搭建移动应用上传回调服务.md) 
-    [STS临时授权访问](../../../../intl.zh-CN/开发指南/隐藏/权限管理/STS临时授权访问.md) 

